name: CI Pipeline

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

  unit-test:
    name: Unit Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run unit tests
        id: unit_tests
        continue-on-error: true
        run: |
          npm run test:unit 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test-output.txt
          retention-days: 30

      - name: Create issue for Copilot analysis on failure
        if: steps.unit_tests.outputs.exit_code != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

          TEST_OUTPUT=$(cat test-output.txt)
          if [ ${#TEST_OUTPUT} -gt 60000 ]; then
            TEST_OUTPUT=$(echo "$TEST_OUTPUT" | tail -c 60000)
          fi

          INSTRUCTIONS=$(cat quality-rules/unit-test.instructions.md)
          ANALYSIS_INSTRUCTIONS=$(cat .github/copilot-analysis-instructions.md)

          ISSUE_BODY=$(cat <<EOF
          ## üö® Unit Test Failure ‚Äì Automated Analysis Request

          ### Pipeline Information
          - **Commit:** \`${SHA}\`
          - **Branch:** \`${GITHUB_REF}\`
          - **Run:** [View workflow run](${RUN_URL})

          ---

          ### üìã Analysis Instructions
          <details>
          <summary>Click to expand analysis instructions</summary>

          ${ANALYSIS_INSTRUCTIONS}

          </details>

          ---

          ### üìä Test Output
          <details>
          <summary>Click to expand full test output</summary>

          \`\`\`
          ${TEST_OUTPUT}
          \`\`\`

          </details>

          ---

          ### üìö Quality Rules Reference
          <details>
          <summary>Click to expand unit test quality rules</summary>

          ${INSTRUCTIONS}

          </details>

          ---

          > ‚ö° This issue was automatically created by the CI pipeline.
          > Copilot should analyze the test failures, identify the root cause in the source code, and open a PR with the fix.
          EOF
          )

          ISSUE_URL=$(gh issue create \
            --title "ü§ñ [Copilot Fix] Unit test failures on ${GITHUB_REF} (${SHA})" \
            --body "$ISSUE_BODY" \
            --label "copilot-fix" \
            --label "unit-test" \
            --label "automated" \
            --assignee "copilot")

          echo "::notice::Issue created: $ISSUE_URL"

      - name: Detect missing tests for source files
        if: always()
        id: missing_tests_check
        run: |
          SOURCE_FILES=$(find src/services src/controllers src/middlewares src/repositories -name '*.js' 2>/dev/null || echo "")

          if [ -z "$SOURCE_FILES" ]; then
            echo "No source files found in testable directories"
            echo "has_gaps=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Source files found:"
          echo "$SOURCE_FILES"

          MISSING_TESTS=""
          LOW_COVERAGE=""

          for file in $SOURCE_FILES; do
            relative_path="${file#src/}"
            test_file="tests/unit/${relative_path%.js}.test.js"

            if [ ! -f "$test_file" ]; then
              MISSING_TESTS="${MISSING_TESTS}- \`${file}\` ‚Üí esperado: \`${test_file}\`\n"
            elif [ -f "coverage/coverage-final.json" ]; then
              coverage_pct=$(node -e "
                const cov = require('./coverage/coverage-final.json');
                const entry = Object.entries(cov).find(([k]) => k.endsWith('${file}'));
                if (entry) {
                  const s = Object.values(entry[1].s);
                  const total = s.length;
                  const covered = s.filter(v => v > 0).length;
                  console.log(total > 0 ? ((covered/total)*100).toFixed(1) : '100');
                } else { console.log('NO_DATA'); }
              " 2>/dev/null || echo "ERROR")

              if [ "$coverage_pct" != "ERROR" ] && [ "$coverage_pct" != "NO_DATA" ]; then
                is_low=$(node -e "console.log(parseFloat('${coverage_pct}') < 80 ? 'true' : 'false')")
                if [ "$is_low" = "true" ]; then
                  LOW_COVERAGE="${LOW_COVERAGE}- \`${file}\` ‚Üí cobertura: ${coverage_pct}%\n"
                fi
              fi
            fi
          done

          echo -e "$MISSING_TESTS" > missing-tests-report.txt
          echo -e "$LOW_COVERAGE" > low-coverage-report.txt
          echo "$SOURCE_FILES" > source-files.txt

          if [ -n "$MISSING_TESTS" ] || [ -n "$LOW_COVERAGE" ]; then
            echo "has_gaps=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_gaps=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue for missing tests
        if: always() && steps.missing_tests_check.outputs.has_gaps == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

          MISSING_TESTS=$(cat missing-tests-report.txt | sed '/^$/d')
          LOW_COVERAGE=$(cat low-coverage-report.txt | sed '/^$/d')
          SOURCE_FILES=$(cat source-files.txt)
          INSTRUCTIONS=$(cat quality-rules/unit-test.instructions.md)
          ANALYSIS_INSTRUCTIONS=$(cat .github/copilot-missing-tests-instructions.md)

          GAPS_SECTION=""
          if [ -n "$MISSING_TESTS" ]; then
            GAPS_SECTION="${GAPS_SECTION}### üö´ Arquivos sem teste unit√°rio correspondente

          ${MISSING_TESTS}

          "
          fi
          if [ -n "$LOW_COVERAGE" ]; then
            GAPS_SECTION="${GAPS_SECTION}### ‚ö†Ô∏è Arquivos com cobertura abaixo do threshold (80%)

          ${LOW_COVERAGE}

          "
          fi

          SOURCE_FILES_LIST=$(echo "$SOURCE_FILES" | sed 's/^/- \`/' | sed 's/$/\`/')

          ISSUE_BODY=$(cat <<EOF
          ## üß™ Missing Tests ‚Äì Test Coverage Gaps

          ### Pipeline Information
          - **Commit:** \`${SHA}\`
          - **Branch:** \`${GITHUB_REF}\`
          - **Run:** [View workflow run](${RUN_URL})

          ---

          ### üìÇ Source Files Analyzed
          ${SOURCE_FILES_LIST}

          ---

          ### üîç Test Coverage Gaps
          ${GAPS_SECTION}

          ---

          ### üìã Analysis Instructions
          <details>
          <summary>Click to expand analysis instructions</summary>

          ${ANALYSIS_INSTRUCTIONS}

          </details>

          ---

          ### üìö Quality Rules Reference
          <details>
          <summary>Click to expand unit test quality rules</summary>

          ${INSTRUCTIONS}

          </details>

          ---

          > ‚ö° This issue was automatically created by the CI pipeline.
          > Copilot should analyze the source code, create the missing unit tests, and open a PR.
          EOF
          )

          ISSUE_URL=$(gh issue create \
            --title "ü§ñ [Copilot Tests] Test coverage gaps on ${GITHUB_REF} (${SHA})" \
            --body "$ISSUE_BODY" \
            --label "copilot-fix" \
            --label "missing-tests" \
            --label "automated" \
            --assignee "copilot")

          echo "::notice::Issue created for missing tests: $ISSUE_URL"

      - name: Fail workflow if tests failed
        if: steps.unit_tests.outputs.exit_code != '0'
        run: exit 1
