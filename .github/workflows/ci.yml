name: CI Pipeline

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

  unit-test:
    name: Unit Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run unit tests
        id: unit_tests
        continue-on-error: true
        run: |
          npm run test:unit 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test-output.txt
          retention-days: 30

      - name: Create issue for Copilot analysis on failure
        if: steps.unit_tests.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const testOutput = fs.readFileSync('test-output.txt', 'utf8');
            const instructions = fs.readFileSync('quality-rules/unit-test.instructions.md', 'utf8');
            const analysisInstructions = fs.readFileSync('.github/copilot-analysis-instructions.md', 'utf8');

            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const sha = context.sha.substring(0, 7);

            const issueBody = `## ğŸš¨ Unit Test Failure â€“ Automated Analysis Request

            ### Pipeline Information
            - **Commit:** \`${sha}\`
            - **Branch:** \`${context.ref}\`
            - **Run:** [View workflow run](${runUrl})

            ---

            ### ğŸ“‹ Analysis Instructions
            <details>
            <summary>Click to expand analysis instructions</summary>

            ${analysisInstructions}

            </details>

            ---

            ### ğŸ“Š Test Output
            <details>
            <summary>Click to expand full test output</summary>

            \`\`\`
            ${testOutput.length > 60000 ? testOutput.substring(testOutput.length - 60000) : testOutput}
            \`\`\`

            </details>

            ---

            ### ğŸ“š Quality Rules Reference
            <details>
            <summary>Click to expand unit test quality rules</summary>

            ${instructions}

            </details>

            ---

            > âš¡ This issue was automatically created by the CI pipeline.
            > Copilot should analyze the test failures, identify the root cause in the source code, and open a PR with the fix.
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– [Copilot Fix] Unit test failures on ${context.ref} (${sha})`,
              body: issueBody,
              labels: ['copilot-fix', 'unit-test', 'automated'],
              assignees: ['copilot']
            });

            core.notice(`Issue created: ${issue.data.html_url}`);

      - name: Detect missing tests for changed source files
        if: always()
        id: missing_tests_check
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 -- 'src/services' 'src/controllers' 'src/middlewares' 'src/repositories' 2>/dev/null || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No source files changed in testable directories"
            echo "has_gaps=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed source files:"
          echo "$CHANGED_FILES"

          MISSING_TESTS=""
          LOW_COVERAGE=""

          for file in $CHANGED_FILES; do
            relative_path="${file#src/}"
            test_file="tests/unit/${relative_path%.js}.test.js"

            if [ ! -f "$test_file" ]; then
              MISSING_TESTS="${MISSING_TESTS}- \`${file}\` â†’ esperado: \`${test_file}\`\n"
            elif [ -f "coverage/coverage-final.json" ]; then
              coverage_pct=$(node -e "
                const cov = require('./coverage/coverage-final.json');
                const entry = Object.entries(cov).find(([k]) => k.endsWith('${file}'));
                if (entry) {
                  const s = Object.values(entry[1].s);
                  const total = s.length;
                  const covered = s.filter(v => v > 0).length;
                  console.log(total > 0 ? ((covered/total)*100).toFixed(1) : '100');
                } else { console.log('NO_DATA'); }
              " 2>/dev/null || echo "ERROR")

              if [ "$coverage_pct" != "ERROR" ] && [ "$coverage_pct" != "NO_DATA" ]; then
                is_low=$(node -e "console.log(parseFloat('${coverage_pct}') < 80 ? 'true' : 'false')")
                if [ "$is_low" = "true" ]; then
                  LOW_COVERAGE="${LOW_COVERAGE}- \`${file}\` â†’ cobertura: ${coverage_pct}%\n"
                fi
              fi
            fi
          done

          echo -e "$MISSING_TESTS" > missing-tests-report.txt
          echo -e "$LOW_COVERAGE" > low-coverage-report.txt
          echo "$CHANGED_FILES" > changed-files.txt

          if [ -n "$MISSING_TESTS" ] || [ -n "$LOW_COVERAGE" ]; then
            echo "has_gaps=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_gaps=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue for missing tests
        if: always() && steps.missing_tests_check.outputs.has_gaps == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const missingTests = fs.readFileSync('missing-tests-report.txt', 'utf8').trim();
            const lowCoverage = fs.readFileSync('low-coverage-report.txt', 'utf8').trim();
            const changedFiles = fs.readFileSync('changed-files.txt', 'utf8').trim();
            const instructions = fs.readFileSync('quality-rules/unit-test.instructions.md', 'utf8');
            const analysisInstructions = fs.readFileSync('.github/copilot-missing-tests-instructions.md', 'utf8');

            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const sha = context.sha.substring(0, 7);

            let gapsSection = '';
            if (missingTests) {
              gapsSection += `### ğŸš« Arquivos sem teste unitÃ¡rio correspondente\n\n${missingTests}\n\n`;
            }
            if (lowCoverage) {
              gapsSection += `### âš ï¸ Arquivos com cobertura abaixo do threshold (80%)\n\n${lowCoverage}\n\n`;
            }

            const changedFilesList = changedFiles.split('\n').map(f => `- \`${f}\``).join('\n');

            const issueBody = `## ğŸ§ª Missing Tests â€“ New Feature Without Test Coverage

            ### Pipeline Information
            - **Commit:** \`${sha}\`
            - **Branch:** \`${context.ref}\`
            - **Run:** [View workflow run](${runUrl})

            ---

            ### ğŸ“‚ Changed Source Files
            ${changedFilesList}

            ---

            ### ğŸ” Test Coverage Gaps
            ${gapsSection}

            ---

            ### ğŸ“‹ Analysis Instructions
            <details>
            <summary>Click to expand analysis instructions</summary>

            ${analysisInstructions}

            </details>

            ---

            ### ğŸ“š Quality Rules Reference
            <details>
            <summary>Click to expand unit test quality rules</summary>

            ${instructions}

            </details>

            ---

            > âš¡ This issue was automatically created by the CI pipeline.
            > Copilot should analyze the source code, create the missing unit tests, and open a PR.
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– [Copilot Tests] Missing tests for new code on ${context.ref} (${sha})`,
              body: issueBody,
              labels: ['copilot-fix', 'missing-tests', 'automated'],
              assignees: ['copilot']
            });

            core.notice(`Issue created for missing tests: ${issue.data.html_url}`);

      - name: Fail workflow if tests failed
        if: steps.unit_tests.outputs.exit_code != '0'
        run: exit 1
